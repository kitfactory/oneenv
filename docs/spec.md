# OneEnv 仕様書

## **1. 概要**

OneEnv は、Python の環境変数管理を簡潔かつ効率的にするライブラリです。
`python-dotenv` のラッパーとして機能し、環境変数テンプレートの収集・管理・差分チェックをサポートします。

## **2. 主要機能**

### **2.1 環境変数テンプレートの管理 (********`template`******** 機能)**

- 各ライブラリが `@oneenv` デコレータを用いた関数を定義し、
  必要な環境変数とその説明を提供。
- OneEnv はそれらの関数を収集し、統合 `.env.example` ファイルを生成。
- **設定項目をテキスト化し、********`.env.example`******** と同一の内容を取得可能。**

### **2.2 設定の差分検出 (********`diff`******** 機能)**

- **過去のテンプレートを保存** し、新たなテンプレートとの **増減を比較**。
- 変更点を明確化することで、環境変数の更新を容易に把握。

### **2.3 重複キーの検出と警告**

- どのライブラリがどの環境変数を利用しているかを確認。
- **キーが重複している場合に警告を出力し、適切な対応を促す。**

## **3. OneEnv のインターフェース**

### **3.1 デコレータ API (********`@oneenv`********)**

各ライブラリは、以下のように `@oneenv` を使用してテンプレートを定義できます。

```python
from oneenv import oneenv

@oneenv
def mylib_template():
    return {
        "MYLIB_API_KEY": {
            "description": """このライブラリが利用するAPIキー
            複数行の説明を記述可能""",
            "default": "",
            "required": True
        },
        "MYLIB_MODE": {
            "description": "ライブラリの動作モード",
            "default": "production",
            "required": True,
            "choices": ["development", "production"]
        }
    }
```

### **3.2 提供される関数一覧**

| **関数名**                                             | **説明**                                        |
| --------------------------------------------------- | --------------------------------------------- |
| `template()`                                        | 収集した設定項目をテキスト化し、`.env.example` を生成            |
| `diff(previous_file, current_file)`                 | 過去のテンプレートとの差分を取得                              |
| `collect_templates()`                               | `@oneenv` デコレータが適用された関数を収集                    |
| `generate_env_example(output_path)`                 | `.env.example` を出力                            |
| `report_duplicates()`                               | 重複するキーを検出し、警告を出力                              |
| `load_dotenv(dotenv_path=None, override=False)`     | `.env` ファイルを読み込み、環境変数として設定                    |
| `dotenv_values(dotenv_path=None, encoding='utf-8')` | `.env` ファイルを辞書として取得                           |
| `set_key(dotenv_path, key_to_set, value_to_set)`    | `.env` ファイルに環境変数を設定                           |
| `unset_key(dotenv_path, key_to_unset)`              | `.env` ファイルから環境変数を削除                          |
| **関数名**                                             | **説明**                                        |
| ------------                                        | --------------------------------------------- |
| `template()`                                        | 収集した設定項目をテキスト化し、\`\`\*\* を生成\*\*              |
| \`\`                                                | **過去**のテンプレートとの差分を取得                          |
| \`\`                                                | \`\`\*\* デコレータが適用された関数を収集\*\*                 |
| \`\`                                                | \`\`\*\* を出力\*\*                              |
| \`\`                                                | 重複す**るキ**ーを検出し、警告を出力                          |

### 3.3 OneEnv の動作フロー

1. `oneenv` デコレータが適用された関数を自動収集。
2. 必須項目 (`des``crip``tion`) をチェックし、
   記載がない場合はエ**ラー**を出力。
3. 収集した情報を統合し、`.env.example` を生成。
4. **`diff`**\*\* 機能で過去のテンプレートとの差分を検出。\*\*
5. **重複するキーがあれば警告を出力し、ライブラリ名を明示。**

### **3.4 ********`.env.example`******** 生成例 (********`template`******** の出力結果)**

```sh
# Auto-generated by OneEnv

# このライブラリが利用するAPIキー
# 複数行の説明を記述可能
# (Defined in: mylib_template)
MYLIB_API_KEY=

# ライブラリの動作モード
# (Defined in: mylib_template)
MYLIB_MODE=production
```

### **3.5 設定の差分検出 (********`diff`******** の出力例)**

- 変更前:

```sh
MYLIB_API_KEY=
MYLIB_MODE=production
```

- 変更後:

```sh
MYLIB_API_KEY=
MYLIB_MODE=development
NEW_SETTING=true
```

- `diff` 出力例:

```sh
+ NEW_SETTING=true
~ MYLIB_MODE=production → development
```

## **4. まとめ**

- **OneEnv は ********`python-dotenv`******** のラッパーとして、環境変数の整理・統一をサポート。**
- **`@oneenv`**\*\* デコレータを使用し、各ライブラリが必要な設定を宣言的に定義可能。\*\*
- **`template`**\*\* 機能により ****`.env.example`**** を自動生成。\*\*
- **`diff`**\*\* 機能により過去のテンプレートとの差分を明示し、環境変数の更新管理を簡単に。\*\*
- **重複キーの警告機能により、チーム開発を効率化。**

