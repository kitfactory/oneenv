# Step 8: CI/CDとの連携

**所要時間:** 15-20分  
**難易度:** 中級〜上級

## 学習目標

- CI/CDパイプラインでのOneEnv活用方法を学ぶ
- 自動テンプレート生成と検証の仕組みを理解する
- 継続的な設定管理のベストプラクティスを実践する
- 複数の環境での設定管理を自動化する

## CI/CDでの課題

### 従来の問題
- 手動での設定ファイル管理
- 環境間での設定不整合
- 新しいパッケージ追加時の設定漏れ
- 設定変更の追跡困難

### OneEnvによる解決
- 自動テンプレート生成
- 設定の一貫性チェック
- 変更の自動検出
- 環境別設定の検証

## 実践演習

### 演習1: GitHub Actionsでの基本設定

1. プロジェクト構造を作成：
```bash
mkdir cicd-oneenv-demo
cd cicd-oneenv-demo
mkdir -p .github/workflows
```

2. 環境テンプレート検証ワークフロー（`.github/workflows/env-template-check.yml`）：

```yaml
name: Environment Template Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'env/**'
      - 'src/**'
  push:
    branches: [main]

jobs:
  validate-env-template:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi
    
    - name: Generate current template
      run: |
        echo "Generating environment template..."
        oneenv template -o .env.example.new
        
        echo "Debug output:"
        oneenv template -d
    
    - name: Check for template changes
      id: template-check
      run: |
        if [ -f .env.example ]; then
          if ! diff -q .env.example .env.example.new > /dev/null; then
            echo "template-changed=true" >> $GITHUB_OUTPUT
            echo "❌ Environment template is outdated!"
            echo "::group::Template Differences"
            oneenv diff .env.example .env.example.new || true
            echo "::endgroup::"
          else
            echo "template-changed=false" >> $GITHUB_OUTPUT
            echo "✅ Environment template is up to date!"
          fi
        else
          echo "template-changed=true" >> $GITHUB_OUTPUT
          echo "⚠️ No existing .env.example found, creating new template"
        fi
    
    - name: Validate template format
      run: |
        echo "Validating template format..."
        
        # テンプレートが適切に生成されているかチェック
        if [ ! -f .env.example.new ]; then
          echo "❌ Template generation failed"
          exit 1
        fi
        
        # 必須設定が含まれているかチェック
        if ! grep -q "Auto-generated by OneEnv" .env.example.new; then
          echo "❌ Template header missing"
          exit 1
        fi
        
        echo "✅ Template format is valid"
    
    - name: Check for secrets in template
      run: |
        echo "Checking for potential secrets in template..."
        
        # 機密情報パターンをチェック
        if grep -i "password.*=" .env.example.new | grep -v "your-password" | grep -v "password123" | grep -v "change-me"; then
          echo "❌ Potential secrets found in template"
          exit 1
        fi
        
        if grep -i "secret.*=" .env.example.new | grep -v "your-secret" | grep -v "secret-key" | grep -v "change-me"; then
          echo "❌ Potential secrets found in template"
          exit 1
        fi
        
        echo "✅ No secrets detected in template"
    
    - name: Upload template artifact
      uses: actions/upload-artifact@v3
      with:
        name: env-template
        path: .env.example.new
    
    - name: Comment on PR (if template changed)
      if: github.event_name == 'pull_request' && steps.template-check.outputs.template-changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const newTemplate = fs.readFileSync('.env.example.new', 'utf8');
          
          const comment = `## 🔄 Environment Template Update Required
          
          The environment template needs to be updated due to changes in dependencies or configuration.
          
          ### Action Required
          1. Download the updated template from the workflow artifacts
          2. Replace the current \`.env.example\` with the new version
          3. Review the changes and commit the updated template
          
          ### Generated Template Preview
          \`\`\`bash
          ${newTemplate.substring(0, 1000)}${newTemplate.length > 1000 ? '...\n(truncated)' : ''}
          \`\`\`
          
          **⚠️ Please review the template changes before merging this PR.**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
```

### 演習2: 自動テンプレート更新ワークフロー

定期的なテンプレート更新（`.github/workflows/auto-update-template.yml`）：

```yaml
name: Auto-update Environment Template

on:
  schedule:
    # 毎週月曜日の午前2時（UTC）に実行
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force template update even if no changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-template:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi
    
    - name: Generate updated template
      run: |
        echo "Generating updated environment template..."
        oneenv template -o .env.example.new
        
        # デバッグ情報を出力
        echo "::group::OneEnv Debug Output"
        oneenv template -d
        echo "::endgroup::"
    
    - name: Check for changes
      id: changes
      run: |
        if [ -f .env.example ]; then
          if ! diff -q .env.example .env.example.new > /dev/null; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Template changes detected"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No template changes"
          fi
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "No existing template found"
        fi
        
        # 強制更新が指定された場合
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "Force update requested"
        fi
    
    - name: Update template file
      if: steps.changes.outputs.has-changes == 'true'
      run: |
        mv .env.example.new .env.example
        echo "Template file updated"
    
    - name: Create Pull Request
      if: steps.changes.outputs.has-changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update environment template"
        title: "🔄 Auto-update environment template"
        body: |
          ## 📝 Automated Environment Template Update
          
          This PR contains an automated update to the environment template.
          
          ### Changes Detected
          - New or updated dependencies may have introduced new environment variables
          - OneEnv has automatically generated an updated `.env.example` file
          
          ### Review Required
          Please review the template changes to ensure:
          - ✅ No sensitive information is exposed
          - ✅ New variables have appropriate default values
          - ✅ Required variables are properly marked
          - ✅ Documentation is clear and accurate
          
          ### Testing
          - [ ] Verify template works in development environment
          - [ ] Check that all new variables are properly documented
          - [ ] Ensure no breaking changes to existing configuration
          
          ---
          *This PR was automatically created by the OneEnv template update workflow.*
        branch: chore/update-env-template
        delete-branch: true
    
    - name: Clean up
      run: |
        if [ -f .env.example.new ]; then
          rm .env.example.new
        fi
```

### 演習3: 環境別デプロイメント検証

複数環境対応ワークフロー（`.github/workflows/multi-env-deploy.yml`）：

```yaml
name: Multi-Environment Deployment

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  validate-configurations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging, production]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Validate environment configuration
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        echo "Validating ${{ matrix.environment }} environment..."
        
        # 環境固有の設定ファイルが存在するかチェック
        if [ -f "env/${{ matrix.environment }}/common.env" ]; then
          echo "✅ Environment configuration found"
        else
          echo "⚠️ Environment configuration not found, using defaults"
        fi
        
        # 設定検証スクリプトを実行（存在する場合）
        if [ -f "scripts/validate_config.py" ]; then
          python scripts/validate_config.py --environment ${{ matrix.environment }}
        fi
    
    - name: Generate environment-specific template
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        # 環境固有のテンプレートを生成
        oneenv template -o .env.example.${{ matrix.environment }}
        
        echo "::group::${{ matrix.environment }} Template"
        cat .env.example.${{ matrix.environment }}
        echo "::endgroup::"
    
    - name: Upload environment template
      uses: actions/upload-artifact@v3
      with:
        name: env-template-${{ matrix.environment }}
        path: .env.example.${{ matrix.environment }}

  deploy-staging:
    needs: validate-configurations
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download staging template
      uses: actions/download-artifact@v3
      with:
        name: env-template-staging
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # ここで実際のデプロイメント処理を実行
        echo "Using template: .env.example.staging"

  deploy-production:
    needs: validate-configurations
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download production template
      uses: actions/download-artifact@v3
      with:
        name: env-template-production
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # ここで実際のデプロイメント処理を実行
        echo "Using template: .env.example.production"
```

### 演習4: Docker環境での設定管理

Docker統合ワークフロー（`.github/workflows/docker-config.yml`）：

```yaml
name: Docker Configuration Management

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  docker-config-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        tags: test-app:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Generate environment template in container
      run: |
        # コンテナ内でOneEnvを実行
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          test-app:latest \
          python -c "
        import oneenv
        import sys
        sys.path.append('/workspace')
        
        # テンプレート生成
        template = oneenv.template()
        with open('.env.example.docker', 'w') as f:
            f.write(template)
        
        print('✅ Docker template generated successfully')
        "
    
    - name: Test configuration loading
      run: |
        # Docker環境での設定読み込みテスト
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e DATABASE_URL=postgresql://postgres:postgres@postgres:5432/testdb \
          test-app:latest \
          python -c "
        import oneenv
        import os
        
        # 環境変数をロード
        oneenv.load_dotenv('.env.example.docker')
        
        # 設定値をテスト
        db_url = os.getenv('DATABASE_URL')
        print(f'Database URL: {db_url}')
        
        if db_url:
            print('✅ Configuration loaded successfully')
        else:
            print('❌ Configuration loading failed')
            exit(1)
        "
    
    - name: Upload Docker template
      uses: actions/upload-artifact@v3
      with:
        name: docker-env-template
        path: .env.example.docker
```

### 演習5: 設定監査とコンプライアンス

設定監査ワークフロー（`.github/workflows/config-audit.yml`）：

```yaml
name: Configuration Audit

on:
  schedule:
    # 毎日午前3時（UTC）に実行
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run security audit
      run: |
        # 設定監査スクリプトを作成
        cat > audit_config.py << 'EOF'
        import oneenv
        import re
        import sys
        from datetime import datetime
        
        def audit_template():
            """環境テンプレートのセキュリティ監査"""
            print(f"🔍 Configuration Audit - {datetime.now().isoformat()}")
            print("=" * 60)
            
            # テンプレート生成
            template = oneenv.template()
            
            errors = []
            warnings = []
            
            # 機密情報パターンをチェック
            secret_patterns = [
                r'password.*=.*[^\\s].*[^example].*[^change]',
                r'secret.*=.*[^\\s].*[^key].*[^change]',
                r'token.*=.*[^\\s].*[^your].*[^change]',
                r'api[_-]?key.*=.*[^\\s].*[^your].*[^change]'
            ]
            
            for pattern in secret_patterns:
                matches = re.findall(pattern, template, re.IGNORECASE)
                if matches:
                    errors.append(f"Potential secret found: {matches}")
            
            # デバッグモードの確認
            if 'DEBUG=True' in template or 'DEBUG=true' in template:
                warnings.append("DEBUG mode is enabled")
            
            # HTTPS強制の確認
            if 'FORCE_HTTPS=False' in template:
                warnings.append("HTTPS enforcement is disabled")
            
            # 結果出力
            if errors:
                print("🔴 SECURITY ERRORS:")
                for error in errors:
                    print(f"  - {error}")
                print()
            
            if warnings:
                print("🟡 SECURITY WARNINGS:")
                for warning in warnings:
                    print(f"  - {warning}")
                print()
            
            if not errors and not warnings:
                print("✅ No security issues detected")
            
            return len(errors) == 0
        
        # 監査実行
        success = audit_template()
        if not success:
            sys.exit(1)
        EOF
        
        python audit_config.py
    
    - name: Check template freshness
      run: |
        # テンプレートの最終更新日をチェック
        if [ -f .env.example ]; then
          last_modified=$(stat -c %Y .env.example)
          current_time=$(date +%s)
          days_old=$(( (current_time - last_modified) / 86400 ))
          
          echo "Template age: $days_old days"
          
          if [ $days_old -gt 30 ]; then
            echo "⚠️ Template is older than 30 days"
            echo "Consider running template update workflow"
          else
            echo "✅ Template is recent"
          fi
        else
          echo "❌ No .env.example file found"
          exit 1
        fi
    
    - name: Generate audit report
      run: |
        # 監査レポートを生成
        cat > audit_report.md << EOF
        # Configuration Audit Report
        
        **Date**: $(date)
        **Repository**: ${{ github.repository }}
        **Commit**: ${{ github.sha }}
        
        ## Template Status
        $(if [ -f .env.example ]; then echo "✅ Template exists"; else echo "❌ Template missing"; fi)
        
        ## Security Checks
        - Secret detection: Completed
        - Debug mode check: Completed
        - HTTPS enforcement check: Completed
        
        ## Recommendations
        - Keep templates updated regularly
        - Review configuration changes during PR reviews
        - Use environment-specific overrides for sensitive values
        
        EOF
        
        cat audit_report.md
    
    - name: Upload audit report
      uses: actions/upload-artifact@v3
      with:
        name: config-audit-report
        path: audit_report.md
```

## CI/CDベストプラクティス

### 1. **自動化レベル**
```yaml
# レベル1: 基本検証
- 設定テンプレートの生成確認
- フォーマット検証

# レベル2: 変更検出
- テンプレート差分の自動検出
- PRでの変更通知

# レベル3: 自動更新
- 定期的なテンプレート更新
- 自動PR作成

# レベル4: セキュリティ監査
- 機密情報スキャン
- 設定コンプライアンスチェック
```

### 2. **環境分離**
```yaml
# 環境ごとの設定検証
strategy:
  matrix:
    environment: [dev, staging, prod]
```

### 3. **エラーハンドリング**
```yaml
# 設定検証失敗時の処理
- name: Notify on failure
  if: failure()
  uses: slack-action
```

### 4. **アーティファクト管理**
```yaml
# テンプレートの保存と共有
uses: actions/upload-artifact@v3
with:
  name: env-templates
  retention-days: 30
```

## トラブルシューティング

### よくある問題と解決方法

1. **テンプレート生成失敗**
```bash
# デバッグモードで確認
oneenv template -d
```

2. **プラグインが発見されない**
```bash
# 依存関係の確認
pip list | grep oneenv
```

3. **設定検証エラー**
```bash
# 環境変数の確認
env | grep ENVIRONMENT
```

## 次のステップ

CI/CD連携を学習完了しました。これでOneEnvの全機能を習得し、実際のプロジェクトで活用できるようになりました。

**→ [チュートリアル完了](README.md)**

### 継続学習のために

1. **実プロジェクトでの活用**
2. **チーム内でのベストプラクティス共有**
3. **OneEnv プラグインの開発と公開**
4. **コミュニティへの貢献**

## よくある質問

### Q: CI/CDでテンプレート生成が失敗する場合は？
A: 依存関係のインストール順序と環境変数の設定を確認してください。

### Q: 大きなプロジェクトでワークフローが遅い場合は？
A: キャッシュの活用と並列実行を検討してください。

### Q: セキュリティスキャンで誤検出が発生する場合は？
A: パターンマッチングのルールを調整し、ホワイトリストを活用してください。

### Q: 複数の環境で設定が競合する場合は？
A: 環境固有の設定ファイルと優先度を明確に定義してください。