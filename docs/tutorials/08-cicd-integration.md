# Step 8: CI/CD Integration

**Duration:** 15-20 minutes  
**Difficulty:** Intermediate to Advanced

## Learning Objectives

- Learn how to utilize OneEnv in CI/CD pipelines
- Understand automatic template generation and validation mechanisms
- Practice continuous configuration management best practices
- Automate configuration management across multiple environments

## CI/CD Challenges

### Traditional Problems
- Manual configuration file management
- Configuration inconsistencies between environments
- Missing configuration when adding new packages
- Difficulty tracking configuration changes

### OneEnv Solutions
- Automatic template generation
- Configuration consistency checks
- Automatic change detection
- Environment-specific configuration validation

## Hands-on Exercises

### Exercise 1: Basic GitHub Actions Setup

1. Create project structure:
```bash
mkdir cicd-oneenv-demo
cd cicd-oneenv-demo
mkdir -p .github/workflows
```

2. Environment template validation workflow (`.github/workflows/env-template-check.yml`):

```yaml
name: Environment Template Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'env/**'
      - 'src/**'
  push:
    branches: [main]

jobs:
  validate-env-template:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi
    
    - name: Generate current template
      run: |
        echo "Generating environment template..."
        oneenv template -o .env.example.new
        
        echo "Debug output:"
        oneenv template -d
    
    - name: Check for template changes
      id: template-check
      run: |
        if [ -f .env.example ]; then
          if ! diff -q .env.example .env.example.new > /dev/null; then
            echo "template-changed=true" >> $GITHUB_OUTPUT
            echo "‚ùå Environment template is outdated!"
            echo "::group::Template Differences"
            oneenv diff .env.example .env.example.new || true
            echo "::endgroup::"
          else
            echo "template-changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Environment template is up to date!"
          fi
        else
          echo "template-changed=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No existing .env.example found, creating new template"
        fi
    
    - name: Validate template format
      run: |
        echo "Validating template format..."
        
        # Check if template is properly generated
        if [ ! -f .env.example.new ]; then
          echo "‚ùå Template generation failed"
          exit 1
        fi
        
        # Check if required configuration is included
        if ! grep -q "Auto-generated by OneEnv" .env.example.new; then
          echo "‚ùå Template header missing"
          exit 1
        fi
        
        echo "‚úÖ Template format is valid"
    
    - name: Check for secrets in template
      run: |
        echo "Checking for potential secrets in template..."
        
        # Check for sensitive information patterns
        if grep -i "password.*=" .env.example.new | grep -v "your-password" | grep -v "password123" | grep -v "change-me"; then
          echo "‚ùå Potential secrets found in template"
          exit 1
        fi
        
        if grep -i "secret.*=" .env.example.new | grep -v "your-secret" | grep -v "secret-key" | grep -v "change-me"; then
          echo "‚ùå Potential secrets found in template"
          exit 1
        fi
        
        echo "‚úÖ No secrets detected in template"
    
    - name: Upload template artifact
      uses: actions/upload-artifact@v3
      with:
        name: env-template
        path: .env.example.new
    
    - name: Comment on PR (if template changed)
      if: github.event_name == 'pull_request' && steps.template-check.outputs.template-changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const newTemplate = fs.readFileSync('.env.example.new', 'utf8');
          
          const comment = `## üîÑ Environment Template Update Required
          
          The environment template needs to be updated due to changes in dependencies or configuration.
          
          ### Action Required
          1. Download the updated template from the workflow artifacts
          2. Replace the current \`.env.example\` with the new version
          3. Review the changes and commit the updated template
          
          ### Generated Template Preview
          \`\`\`bash
          ${newTemplate.substring(0, 1000)}${newTemplate.length > 1000 ? '...\n(truncated)' : ''}
          \`\`\`
          
          **‚ö†Ô∏è Please review the template changes before merging this PR.**`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
```

### Exercise 2: Automatic Template Update Workflow

Periodic template updates (`.github/workflows/auto-update-template.yml`):

```yaml
name: Auto-update Environment Template

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force template update even if no changes'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-template:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi
    
    - name: Generate updated template
      run: |
        echo "Generating updated environment template..."
        oneenv template -o .env.example.new
        
        # Output debug information
        echo "::group::OneEnv Debug Output"
        oneenv template -d
        echo "::endgroup::"
    
    - name: Check for changes
      id: changes
      run: |
        if [ -f .env.example ]; then
          if ! diff -q .env.example .env.example.new > /dev/null; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Template changes detected"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No template changes"
          fi
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "No existing template found"
        fi
        
        # If force update is specified
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "Force update requested"
        fi
    
    - name: Update template file
      if: steps.changes.outputs.has-changes == 'true'
      run: |
        mv .env.example.new .env.example
        echo "Template file updated"
    
    - name: Create Pull Request
      if: steps.changes.outputs.has-changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update environment template"
        title: "üîÑ Auto-update environment template"
        body: |
          ## üìù Automated Environment Template Update
          
          This PR contains an automated update to the environment template.
          
          ### Changes Detected
          - New or updated dependencies may have introduced new environment variables
          - OneEnv has automatically generated an updated `.env.example` file
          
          ### Review Required
          Please review the template changes to ensure:
          - ‚úÖ No sensitive information is exposed
          - ‚úÖ New variables have appropriate default values
          - ‚úÖ Required variables are properly marked
          - ‚úÖ Documentation is clear and accurate
          
          ### Testing
          - [ ] Verify template works in development environment
          - [ ] Check that all new variables are properly documented
          - [ ] Ensure no breaking changes to existing configuration
          
          ---
          *This PR was automatically created by the OneEnv template update workflow.*
        branch: chore/update-env-template
        delete-branch: true
    
    - name: Clean up
      run: |
        if [ -f .env.example.new ]; then
          rm .env.example.new
        fi
```

### Exercise 3: Multi-Environment Deployment Validation

Multi-environment workflow (`.github/workflows/multi-env-deploy.yml`):

```yaml
name: Multi-Environment Deployment

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  validate-configurations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging, production]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Validate environment configuration
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        echo "Validating ${{ matrix.environment }} environment..."
        
        # Check if environment-specific configuration files exist
        if [ -f "env/${{ matrix.environment }}/common.env" ]; then
          echo "‚úÖ Environment configuration found"
        else
          echo "‚ö†Ô∏è Environment configuration not found, using defaults"
        fi
        
        # Run configuration validation script (if it exists)
        if [ -f "scripts/validate_config.py" ]; then
          python scripts/validate_config.py --environment ${{ matrix.environment }}
        fi
    
    - name: Generate environment-specific template
      env:
        ENVIRONMENT: ${{ matrix.environment }}
      run: |
        # Generate environment-specific template
        oneenv template -o .env.example.${{ matrix.environment }}
        
        echo "::group::${{ matrix.environment }} Template"
        cat .env.example.${{ matrix.environment }}
        echo "::endgroup::"
    
    - name: Upload environment template
      uses: actions/upload-artifact@v3
      with:
        name: env-template-${{ matrix.environment }}
        path: .env.example.${{ matrix.environment }}

  deploy-staging:
    needs: validate-configurations
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download staging template
      uses: actions/download-artifact@v3
      with:
        name: env-template-staging
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Execute actual deployment process here
        echo "Using template: .env.example.staging"

  deploy-production:
    needs: validate-configurations
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download production template
      uses: actions/download-artifact@v3
      with:
        name: env-template-production
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Execute actual deployment process here
        echo "Using template: .env.example.production"
```

### Exercise 4: Docker Environment Configuration Management

Docker integration workflow (`.github/workflows/docker-config.yml`):

```yaml
name: Docker Configuration Management

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  docker-config-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.test
        push: false
        tags: test-app:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Generate environment template in container
      run: |
        # Run OneEnv inside container
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          test-app:latest \
          python -c "
        import oneenv
        import sys
        sys.path.append('/workspace')
        
        # Generate template
        template = oneenv.template()
        with open('.env.example.docker', 'w') as f:
            f.write(template)
        
        print('‚úÖ Docker template generated successfully')
        "
    
    - name: Test configuration loading
      run: |
        # Test configuration loading in Docker environment
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e DATABASE_URL=postgresql://postgres:postgres@postgres:5432/testdb \
          test-app:latest \
          python -c "
        import oneenv
        import os
        
        # Load environment variables
        oneenv.load_dotenv('.env.example.docker')
        
        # Test configuration values
        db_url = os.getenv('DATABASE_URL')
        print(f'Database URL: {db_url}')
        
        if db_url:
            print('‚úÖ Configuration loaded successfully')
        else:
            print('‚ùå Configuration loading failed')
            exit(1)
        "
    
    - name: Upload Docker template
      uses: actions/upload-artifact@v3
      with:
        name: docker-env-template
        path: .env.example.docker
```

### Exercise 5: Configuration Auditing and Compliance

Configuration audit workflow (`.github/workflows/config-audit.yml`):

```yaml
name: Configuration Audit

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install oneenv
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run security audit
      run: |
        # Create configuration audit script
        cat > audit_config.py << 'EOF'
        import oneenv
        import re
        import sys
        from datetime import datetime
        
        def audit_template():
            """Security audit of environment template"""
            print(f"üîç Configuration Audit - {datetime.now().isoformat()}")
            print("=" * 60)
            
            # Generate template
            template = oneenv.template()
            
            errors = []
            warnings = []
            
            # Check for sensitive information patterns
            secret_patterns = [
                r'password.*=.*[^\s].*[^example].*[^change]',
                r'secret.*=.*[^\s].*[^key].*[^change]',
                r'token.*=.*[^\s].*[^your].*[^change]',
                r'api[_-]?key.*=.*[^\s].*[^your].*[^change]'
            ]
            
            for pattern in secret_patterns:
                matches = re.findall(pattern, template, re.IGNORECASE)
                if matches:
                    errors.append(f"Potential secret found: {matches}")
            
            # Check debug mode
            if 'DEBUG=True' in template or 'DEBUG=true' in template:
                warnings.append("DEBUG mode is enabled")
            
            # Check HTTPS enforcement
            if 'FORCE_HTTPS=False' in template:
                warnings.append("HTTPS enforcement is disabled")
            
            # Output results
            if errors:
                print("üî¥ SECURITY ERRORS:")
                for error in errors:
                    print(f"  - {error}")
                print()
            
            if warnings:
                print("üü° SECURITY WARNINGS:")
                for warning in warnings:
                    print(f"  - {warning}")
                print()
            
            if not errors and not warnings:
                print("‚úÖ No security issues detected")
            
            return len(errors) == 0
        
        # Run audit
        success = audit_template()
        if not success:
            sys.exit(1)
        EOF
        
        python audit_config.py
    
    - name: Check template freshness
      run: |
        # Check template last modified date
        if [ -f .env.example ]; then
          last_modified=$(stat -c %Y .env.example)
          current_time=$(date +%s)
          days_old=$(( (current_time - last_modified) / 86400 ))
          
          echo "Template age: $days_old days"
          
          if [ $days_old -gt 30 ]; then
            echo "‚ö†Ô∏è Template is older than 30 days"
            echo "Consider running template update workflow"
          else
            echo "‚úÖ Template is recent"
          fi
        else
          echo "‚ùå No .env.example file found"
          exit 1
        fi
    
    - name: Generate audit report
      run: |
        # Generate audit report
        cat > audit_report.md << EOF
        # Configuration Audit Report
        
        **Date**: $(date)
        **Repository**: ${{ github.repository }}
        **Commit**: ${{ github.sha }}
        
        ## Template Status
        $(if [ -f .env.example ]; then echo "‚úÖ Template exists"; else echo "‚ùå Template missing"; fi)
        
        ## Security Checks
        - Secret detection: Completed
        - Debug mode check: Completed
        - HTTPS enforcement check: Completed
        
        ## Recommendations
        - Keep templates updated regularly
        - Review configuration changes during PR reviews
        - Use environment-specific overrides for sensitive values
        
        EOF
        
        cat audit_report.md
    
    - name: Upload audit report
      uses: actions/upload-artifact@v3
      with:
        name: config-audit-report
        path: audit_report.md
```

## CI/CD Best Practices

### 1. **Automation Levels**
```yaml
# Level 1: Basic validation
- Configuration template generation verification
- Format validation

# Level 2: Change detection
- Automatic template diff detection
- PR change notifications

# Level 3: Automatic updates
- Periodic template updates
- Automatic PR creation

# Level 4: Security auditing
- Sensitive information scanning
- Configuration compliance checks
```

### 2. **Environment Separation**
```yaml
# Environment-specific configuration validation
strategy:
  matrix:
    environment: [dev, staging, prod]
```

### 3. **Error Handling**
```yaml
# Processing when configuration validation fails
- name: Notify on failure
  if: failure()
  uses: slack-action
```

### 4. **Artifact Management**
```yaml
# Template storage and sharing
uses: actions/upload-artifact@v3
with:
  name: env-templates
  retention-days: 30
```

## Troubleshooting

### Common Issues and Solutions

1. **Template Generation Failure**
```bash
# Check with debug mode
oneenv template -d
```

2. **Plugin Not Discovered**
```bash
# Check dependencies
pip list | grep oneenv
```

3. **Configuration Validation Error**
```bash
# Check environment variables
env | grep ENVIRONMENT
```

## Next Steps

You have completed learning CI/CD integration. You now have mastery of all OneEnv features and can utilize them in real projects.

**‚Üí [Tutorial Complete](README.md)**

### For Continued Learning

1. **Utilize in real projects**
2. **Share best practices within your team**
3. **Develop and publish OneEnv plugins**
4. **Contribute to the community**

## Frequently Asked Questions

### Q: What if template generation fails in CI/CD?
A: Check the dependency installation order and environment variable settings.

### Q: What if workflows are slow in large projects?
A: Consider utilizing caching and parallel execution.

### Q: What if security scans produce false positives?
A: Adjust pattern matching rules and utilize whitelisting.

### Q: What if configurations conflict across multiple environments?
A: Clearly define environment-specific configuration files and priorities.